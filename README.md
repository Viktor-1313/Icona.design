## Диаграмма Ганта ICONA — модуль `implementation_schedule.html`

Этот модуль — отдельная страница с интерактивной диаграммой Ганта для планирования внедрения и обучения системе ICONA.

- **Фронтенд‑страница**: `implementation_schedule.html`  
- **Бэкенд‑сервер**: `server.js` (Node + Express, простое API для сохранения/загрузки состояния диаграммы)

---

## Что умеет модуль (по смыслу)

- **Адаптивная временная шкала**
  - Переключение уровней детализации в зависимости от масштаба:
    - по дням (отдельные даты, выделение выходных и праздников);
    - по неделям (подписи вида `10–16` + месяц на отдельной строке, агрегация задач по неделям; названия месяцев всегда выровнены по высоте);
    - по месяцам (подписи `Февраль 2025`, агрегация задач по месяцам).
  - При максимальном отдалении виден весь проект + «хвост» до конца следующего года.
  - Серый «хвост» временной шкалы после конца последней задачи визуально отделяет будущее расширение плана.

- **Задачи и статусы**
  - Структура: этап, вид контроля, мероприятие, даты начала/окончания, количество рабочих дней, **ответственный**, статус.
  - Поддерживаемые статусы задачи:
    - Запланирована
    - В работе
    - Завершено
    - Доп. статусы для отдельных дней через контекстное меню (выходной, праздник и т.п.);  
      дни со статусами «выходной» и «праздник» подсвечиваются в Ганте отдельными цветами (розовый / жёлтый).
  - В таблице под диаграммой можно менять даты начала/окончания и количество рабочих дней:
    - если заданы **дата начала + рабочие дни** — дата окончания считается автоматически по рабочим дням;
    - если заданы **дата окончания + рабочие дни** — дата начала пересчитывается «назад» по рабочим дням;
    - если заданы **обе даты** — пересчитывается количество рабочих дней между ними.
  - Все последующие задачи образуют **жёсткую последовательность**: каждая новая задача начинается на следующий день после окончания предыдущей, при этом её длительность в рабочих днях сохраняется и хвост графика сдвигается.
  - При установке статуса **«В работе»** или **«Завершено»** по ячейке/диапазону открывается модальное окно для ввода комментария; комментарий сохраняется по датам и:
    - при наведении на закрашенную ячейку под ней всплывает чёрная подсказка с текстом комментария;
    - стандартный браузерный `title` для баров Ганта отключён, чтобы по ховеру отображался **только** текст комментария.
  - В детальном режиме:
    - при статусе **«В работе»** комментарии хранятся отдельно по каждой дате интервала;
    - при статусе **«Завершено (с начала по выбранную дату)»** все оставшиеся рабочие дни задачи перекрашиваются в зелёный, **но комментарии остаются привязаны к своим датам**: уже существующие тексты не затираются, а новый комментарий (если введён при завершении) привязывается только к выбранной дате завершения.
  - В таблице можно редактировать:
    - **Этап** — общее название группы задач; изменение названия для одной строки автоматически переименовывает все задачи с тем же этапом.  
      Префикс «Этап N.» защищён от редактирования, редактируется только текст после него.
    - **Вид контроля** — настраивается индивидуально для каждой задачи и не влияет на остальные строки.

- **Учёт рабочего календаря**
  - Старт проекта задаётся через `startDate` и может изменяться пользователем.
  - Рабочие дни считаются с учётом выходных и официальных праздников РФ (массив `holidays`).
  - Для каждой задачи вычисляются реальные календарные даты начала/окончания и массив рабочих дат.

- **Брендинг компании**
  - Под заголовком блока добавлен контейнер с логотипом и названием компании.
  - Слева — крупное превью логотипа (по умолчанию `favicon.png`) и надпись «Выберите файл» прямо поверх PNG; при загрузке нового PNG надпись исчезает.
  - Справа — название компании: по умолчанию серый текст «Введите название компании»; при вводе название набирается прямо в этой строке, отображается крупным градиентным текстом (от красного к тёмно‑красному), можно использовать и строчные, и прописные буквы.
  - Название и логотип **не сбрасываются** при нажатии на «Сбросить план» — сбрасывается только сам график.

- **Интерактивность диаграммы и управление задачами**
  - Клик по бару задачи открывает контекстное меню со статусами дня:
    - «В работе»,
    - «Завершено (с начала по выбранную дату)»,
    - «Выходной / Праздник» и др.
  - При выборе статуса диаграмма автоматически перерисовывается.
  - Переключатель режима отображения баров:
    - **Общий вид** — сплошные полосы по интервалам без детализации по дням (статус меняется сразу для всей задачи); цепочки задач образуют непрерывные полосы, одиночные задачи в интервале рисуются с закруглёнными краями.
    - **Детальный вид** — покраска по отдельным рабочим дням (можно менять статус по дням/неделям/месяцам).
  - Отдельная кнопка **«Ответственный»**:
    - при включении добавляет в левую часть Ганта столбец «Ответственный» (после «Рабочих дней») и показывает соответствующий столбец в таблице;
    - при выключении колонка скрывается на странице, но данные по ответственным сохраняются в задачах.
  - Изменения в таблице задач сразу пересчитывают временную шкалу и бары в диаграмме, и наоборот.
  - Поддерживается drag&drop строк задач и горизонтальный зум (сочетание Z + колесо мыши над диаграммой).
  - Один клик по задаче (в Ганте или в таблице) выделяет строку и подсвечивает её: при обычном режиме — мягкий голубой цвет, при включённом фильтре по этапу — все задачи выбранного этапа подсвечены светло‑голубым, выбранная строка чуть темнее.
  - **Insert** — вставляет новую задачу под выделенной: дата начала = следующий рабочий день после конца выделенной задачи, длительность по умолчанию 1 рабочий день; последующие задачи автоматически сдвигаются, сохраняя свою длительность.
  - **Delete** — удаляет выделенную задачу с подтверждением: появляется диалог «Удалить задачу?», Enter = удалить, Escape/«Нет» = отмена; после удаления следующая задача «подтягивается» вперёд (дата начала = конец предыдущей + 1 день), хвост пересчитывается.
  - **Стрелки вверх/вниз** — навигация по задачам с клавиатуры: выделение перемещается по списку задач, соответствующая строка в Ганте автоматически прокручивается в зону видимости.
  - Кнопки этапов над диаграммой (`Все этапы`, `Этап 1`, `Этап 2`, `Этап 3`, `Этап 4`) позволяют группировать задачи по этапам: при выборе конкретного этапа задачи этого этапа подсвечиваются светло‑голубым, остальные строки становятся полупрозрачными и неактивными; при выборе `Все этапы` фильтр сбрасывается.
  - Кнопки управления над диаграммой имеют кастомные CSS‑иконки (без эмодзи и стандартных картинок): иконка диаграммы в заголовке, иконка PDF, таблицы Excel, переключения вида (Гант/таблица) и сброса плана (`Сбросить план` с подсказкой «Сбросить все даты до дефолтных значений»).

- **Выгрузка данных**
  - **PDF**: кнопка «Выгрузить в PDF» сохраняет текущий вид Ганта с логотипом и названием компании.  
    Техническое ограничение: при очень длинных проектах браузер может обрезать диаграмму по ширине/высоте — PDF‑выгрузка сделана как «красивый скриншот», а не как строгий отчёт.
  - **Excel/CSV**:
    - Если библиотека `xlsx` доступна:
      - создаётся файл `График_внедрения_ICONA.xlsx` с двумя листами:
        1. **Лист‑Гант**: над кнопкой выгрузки есть выпадающий список масштаба (`дни / недели / месяцы / годы`).  
           В первом столбце — наименование задачи, далее даты начала/окончания/кол‑во рабочих дней и временная шкала;  
           ячейки шкалы закрашены в цвета, соответствующие статусам задач и отдельным дням (план — синий, в работе — оранжевый, завершено — зелёный, выходной/праздник — отдельные оттенки).  
           Если по датам внутри интервала есть комментарии, они добавляются в ячейку как **комментарий Excel** (note): при наведении в Excel видно текст вида  
           `YYYY-MM-DD: комментарий` (по строке на каждую дату с текстом).
        2. **Лист `Задачи`**: детальная таблица задач как на странице (включая столбец «Ответственный» — он выгружается всегда, даже если на странице колонка скрыта) и дополнительный столбец **«Комментарии по датам»** с агрегированным списком вида  
           `YYYY-MM-DD: комментарий; YYYY-MM-DD: комментарий ...`.
    - Если `xlsx` недоступна (например, нет доступа к CDN), модуль автоматически делает выгрузку в CSV (`График_внедрения_ICONA.csv`) в той же структуре (сначала блок Ганта, затем таблица задач), файл открывается в Excel без дополнительной настройки.

---

## Как запустить локально (для проверки)

1. Перейти в папку `1`:

   ```bash
   cd 1
   npm install
   node server.js
   ```

2. Открыть в браузере:

   ```text
   http://localhost:3100/implementation_schedule.html
   ```

3. Проверить работу сохранения/загрузки состояния через API `/api/gantt-state`:
   - `GET /api/gantt-state` — вернуть текущее сохранённое состояние (файл `gantt-state.json`);
   - `POST /api/gantt-state` — сохранить новое состояние в `gantt-state.json`.

Если файла `gantt-state.json` ещё нет, сервер создаст его при первом сохранении.

---

## Минимальный набор файлов для GitHub / деплоя

Чтобы модуль можно было отдельно выложить и развернуть, в папке `1` должны быть как минимум:

- `implementation_schedule.html` — сама страница с диаграммой Ганта;
- `server.js` — простой сервер на Express, который:
  - отдаёт статические файлы из папки `1`;
  - обрабатывает `GET/POST /api/gantt-state` и работает с `gantt-state.json`.
- `gantt-state.json` — файл с сохранённым состоянием (может создаваться автоматически).
- `xlsx.min.js` — локальная копия библиотеки XLSX для экспорта в Excel (лежит рядом с `implementation_schedule.html`, чтобы не зависеть от CDN в корпоративной сети).
- `package.json` — описание проекта и зависимостей:

```json
{
  "name": "icona-gantt-schedule",
  "version": "1.0.0",
  "description": "Интерактивная диаграмма Ганта ICONA",
  "main": "server.js",
  "scripts": {
    "start": "node server.js"
  },
  "dependencies": {
    "cors": "^2.8.5",
    "express": "^5.1.0"
  }
}
```

---

## Подсказка для деплоя (например, через GitHub + Render/Railway)

Если этот README открыт на GitHub и нужно быстро понять, как развернуть модуль:

1. **Что именно разворачиваем**
   - фронтенд‑страницу: `implementation_schedule.html`;
   - Node/Express‑сервер: `server.js` с API `/api/gantt-state`.

2. **Куда деплоить**
   - Код хранится в репозитории GitHub;
   - Платформа должна уметь запускать Node/Express‑приложение
     (Render, Railway, Fly.io, любой VPS и т.п.);
   - Команда запуска сервера: `npm start`.

3. **Что получится на выходе**
   - Публичный URL вида:

     `https://<имя‑сервера>/implementation_schedule.html`

   - Страница по этому адресу должна уметь:
     - загружать состояние диаграммы из `/api/gantt-state`;
     - сохранять изменения обратно в `/api/gantt-state` по мере работы пользователя.

Если в этом файле чего‑то не хватает для конкретного варианта деплоя, можно дополнить раздел «Подсказка для деплоя» под вашу площадку.# implementation_schedule
